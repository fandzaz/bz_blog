<?php
     header("Access-Control-Allow-Origin: *");
?>
<!DOCTYPE html>
<html lang="en" ng-app="app">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat Template</title>
     <link href="/stylesheets/normalize.css" rel="stylesheet">
    <link href="/stylesheets/page.css" rel="stylesheet">
    <link href="/stylesheets/chat.css" rel="stylesheet">
	
	
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	<link href="/stylesheets/magnific-popup.css" rel="stylesheet">
    <link href="/stylesheets/dropzone.css" rel="stylesheet">
  </head>
  <body  ng-controller="chat"  >
  		<div class="list" compile="body_chat"></div>
	  <ul>
		  <li>mini session chat ......... DONE</li>
		  <li>add friend will be create new group | auto complete their friend ......... DONE</li>
		  <li>chat setting dropdown ......... DONE</li>
		  <li>close widget | clear session chat ......... DONE</li>
		  <li>Modal view photo ......... DONE</li>
		  <li>upload photo process ......... DONE</li>
		  <li>Emoticon ......... DONE</li>
		  <li>Quick Emoticon ......... DONE</li>
	  </ul>
	  
	    <div class="chat-sidebar">
            <div class="sidebar-name" ng-repeat="f in list">
                <!-- Pass username and display name to register popup -->
                <a href="javascript:void(0)" ng-click="register_popup(f._id,f.name)">
                    <img width="30" height="30" src="https://im.bazarn.com/45x45/{{f.picture}}" />
                    <span>{{f.name}}</span>
                </a>
            </div>
<!--
            <div class="sidebar-name">
                <a href="javascript:register_popup('qnimate', 'QNimate');">
                    <img width="30" height="30" src="https://im.bazarn.com/90x90/uploads/shoplogo_56e3c109f0d71d097a8b4567_53404480.jpeg" />
                    <span>QNimate</span>
                </a>
            </div>
            <div class="sidebar-name">
                <a href="javascript:register_popup('qscutter', 'QScutter');">
                    <img width="30" height="30" src="https://im.bazarn.com/90x90/uploads/shoplogo_56e2666af0d71dc0758b4567_1383634472.jpeg" />
                    <span>QScutter</span>
                </a>
            </div>
            <div class="sidebar-name">
                <a href="javascript:register_popup('qidea', 'QIdea');">
                    <img width="30" height="30" src="https://im.bazarn.com/90x90/uploads/avatar_56e2543cf0d71d4e5d8b4567_1146068162.jpg" />
                    <span>QIdea</span>
                </a>
            </div>
            <div class="sidebar-name">
                <a href="javascript:register_popup('qazy', 'QAzy');">
                    <img width="30" height="30" src="https://im.bazarn.com/90x90/uploads/avatar_56e27075f0d71daa0e8b4567_2091331663.jpg" />
                    <span>QAzy</span>
                </a>
            </div>
            <div class="sidebar-name">
                <a href="javascript:register_popup('qblock', 'QBlock');">
                    <img width="30" height="30" src="https://im.bazarn.com/90x90/uploads/avatar_56e273eff0d71dff138b4567_1668053170.jpg" />
                    <span>QBlock</span>
                </a>
            </div>
-->
        </div>
<div class='chat-sidebar-sp' id='chat-sidebar-sp'>
	<button  class='xtabs-min'>&ndash;</button>
<ul class="xtabs">
    <li>
        <input type="radio" name="tabs" id="tab1" checked />
        <label for="tab1">เพื่อน</label>
        <div id="tab-content1" class="tab-content">
            <ul class='thisismyfriend'>
	            <li  ng-repeat='n in list'>
		            <a href='#'>
			            <div class='av'><img src='https://im.bazarn.com/90x90/{{n.picture}}'></div>
			            <div class='fordetail'>
				            <div class='hername'>{{n.name}}</div>
				            <div class='online-state'>
					            <div class='online{{n._id}} mystate iamoffline'></div><span class='online_text{{n._id}}'>ออฟไลน์ เมื่อ 4 นาทีที่แล้ว</span>
<!-- 					            <div class='mystate iamalway'></div><span>ออนไลน์แต่กำลังทำบางอย่าง</span> -->
				            </div>
			            </div>
		            </a>
	            </li>
            </ul>
        </div>
    </li>
       <li>
        <input type="radio" name="tabs" id="tab2"  />
        <label for="tab2">กลุ่ม</label>
        <div id="tab-content2" class="tab-content">
            <ul class='thisismygroup'>
	            <li ng-repeat='g in list_group'>
		            <a href='#'>
			            <div class='av'><img src='https://im.bazarn.com/90x90/uploads/avatar_56e273eff0d71dff138b4567_1668053170.jpg'></div>
			            <div class='fordetail'>
				            <div class='hername'>{{g.name_group}}</div>
				            <div class='whois_ingroup' >
					            <img ng-repeat='m in g.user | limitTo:5' src='https://im.bazarn.com/90x90/{{m.picture}}'>
					            <span>{{check_num(g.user.length)}}</span>
				            </div>
			            </div>
		            </a>
	            </li>

            </ul>
        </div>
    </li>
    <li>
        <input type="radio" name="tabs" id="tab3" />
        <label for="tab3">มีกิจกรรมร่วมกัน</label>
        <div id="tab-content3" class="tab-content">
            <ul class='thisismyfriend'>
	            <li ng-repeat="a in activities">
		            <a href='#'>
			            <div class='av'><img src='https://im.bazarn.com/90x90/{{a.picture}}'></div>
			            <div class='fordetail'>
				            <div class='hername'>{{a.name}}</div>
				            <div class='online-state'>
					            <i class="fa fa-user"></i> <div class='mystate iamalway'></div><span>ออนไลน์แต่กำลังทำบางอย่าง</span>
				            </div>
			            </div>
		            </a>
	            </li>

            </ul>
        </div>
    </li>
</ul>
<div class='searchtab' contenteditable="true" data-placeholder='ค้นหา'></div>        
</div>
<div class='minsearch'><i class="fa fa-search-plus"></i>
	<div class='labal'>2</div>
</div>

<?php include('master_chat.php');?>	

<!-- CHAT PANEL -->
<!--
<div class='chat-popup'>
	<header>
	</header>
	<div class='name_head'><div class='name'>ชื่อและนามสกุล</div> <button  class='chat-popup-xc close_this_popup'><i class="fa fa-times"></i></button></div>
	<button  class='chat-popup-cc close_this_popup'><i class="fa fa-times"></i></button>
	<button  class='chat-popup-cc posrel dd_cog'><i class="fa fa-cog"></i>
	    <ul class='setting_list'>
		    <li><a href='javascript:void(0);' class='plus_friend'>เพิ่มเพื่อน</a></li>
		    <li><a href='javascript:void(0);' class="show-group-setting">แก้ไขชื่อการสนทนา</a></li>
		    <li><a href='javascript:void(0);' class="show-friend-ingroup">แก้ไขผู้มีส่วนร่วม</a></li>
	    </ul>
	</button>
	<button  class='chat-popup-cc plus_friend'><i class="fa fa-user-plus"></i></button>
	<div class='ichatwith'>
		<div class='inchat'>
			<div class='av'><img src='https://im.bazarn.com/90x90/uploads/avatar_56e273eff0d71dff138b4567_1668053170.jpg'></div>
			<div class='inchat-detail'>
				<div class='hername'><a href='#'>ชื่อร้าน หรือ ชื่อและนามสกุล ชื่อร้าน หรือ ชื่อและนามสกุล</a></div>
			</div>
		</div>
	</div>
	<div class='chatarea'>
		
		<div class='find_frined'>
			<input type='text' class='input_friend' name='' value='' placeholder="ค้นหาเพื่อน">
			<button  class='chat-popup-cp close_find_friend'><i class="fa fa-times"></i></button>
			<ul class='myfriendlist'>
				<li><a href='#'><img src='https://im.bazarn.com/90x90/uploads/avatar_56e273eff0d71dff138b4567_1668053170.jpg'><div class='span'>his / her namehis / her namehis / her name</div></a></li>
				<li><a href='#'><img src='https://im.bazarn.com/90x90/uploads/avatar_56e273eff0d71dff138b4567_1668053170.jpg'><div class='span'>his / her name</div></a></li>
				<li><a href='#'><img src='https://im.bazarn.com/90x90/uploads/avatar_56e273eff0d71dff138b4567_1668053170.jpg'><div class='span'>his / her name</div></a></li>
				<li><a href='#'><img src='https://im.bazarn.com/90x90/uploads/avatar_56e273eff0d71dff138b4567_1668053170.jpg'><div class='span'>his / her name</div></a></li>
				<li><a href='#'><img src='https://im.bazarn.com/90x90/uploads/avatar_56e273eff0d71dff138b4567_1668053170.jpg'><div class='span'>his / her name</div></a></li>
			</ul>
		</div>
		<div class='msgsc'>
			
			<div class='item-chat myfriend'>
				<div class='chat_av'><img src='https://im.bazarn.com/90x90/uploads/avatar_56e27075f0d71daa0e8b4567_2091331663.jpg'></div>
				<div class='messages'>
					<div class='bubble'>
						<span>ทดสอบ text messages และ emoticon จะใช้บล็อคแบบนี้ สำหรับคู่ร่วมสนทนา</span>
					</div>
					<div class='msg_date'>วันนี้13:36</div>
					<div class='msg_is_read'><i class="fa fa-check"></i>เหม่ง,ลิงกัง,เค็มจังโฮ <span>อ่านแล้ว</span></div>
				</div>
			</div>
			<div class='item-chat myfriend'>
				<div class='chat_av'><img src='https://im.bazarn.com/90x90/uploads/avatar_56e27075f0d71daa0e8b4567_2091331663.jpg'></div>
				<div class='messages gal'>
					<div class='img-chat'>
						<div class='img'>
							<a href='https://www.bazarn.com/media/post_56e25920f0d71dae628b4567_1004040274.png'>
								<img src='https://www.bazarn.com/media/post_56e25920f0d71dae628b4567_1004040274.png'>
							</a>
						</div>
					</div>
					<div class='img-chat'>
						<div class='img'>
							<a href='https://im.bazarn.com/676x676/media/product_56e27075f0d71daa0e8b4567_1343950483.jpg'>
								<img src='https://im.bazarn.com/676x676/media/product_56e27075f0d71daa0e8b4567_1343950483.jpg'>
							</a>
						</div>
					</div>
					<div class='img-chat'>
						<div class='img'>
							<a href='https://im.bazarn.com/676x676/media/product_56e25920f0d71dae628b4567_715432412.jpg'>
								<img src='https://im.bazarn.com/676x676/media/product_56e25920f0d71dae628b4567_715432412.jpg'>
							</a>
						</div>
					</div>
					<div class='img-chat'>
						<div class='img'>
							<a href='https://im.bazarn.com/676x676/media/post_564953398992f718040041ad_2035307614.png'>
								<img src='https://im.bazarn.com/676x676/media/post_564953398992f718040041ad_2035307614.png'>
							</a>
						</div>
					</div>
					<div class='msg_date'>วันนี้13:36</div>
					<div class='msg_is_read'><i class="fa fa-check"></i>เหม่ง,ลิงกัง,เค็มจังโฮ <span>อ่านแล้ว</span></div>
				</div>
			</div>
			<div class='item-chat myfriend'>
				<div class='chat_av'><img src='https://im.bazarn.com/90x90/uploads/avatar_56e27075f0d71daa0e8b4567_2091331663.jpg'></div>
				<div class='messages'>
					<div class='sendlink'>
						<a href='https://www.bazarn.com' target='_blank'>link title</a>
					</div>
					<div class='msg_date'>วันนี้13:36</div>
					<div class='msg_is_read'><i class="fa fa-check"></i>เหม่ง,ลิงกัง,เค็มจังโฮ <span>อ่านแล้ว</span></div>
				</div>
			</div>
			
			
			
			<div class='item-chat itsme'>
				<div class='messages'>
					<div class='bubble'>
						<span>ทดสอบ text messagesทดสอบ text messagesทดสอบ text messagesทดสอบ text messagesทดสอบ text messagesทดสอบ text messagesทดสอบ text messagesทดสอบ</span>
					</div>
					<div class='msg_date'>วันนี้13:36</div>
					<div class='msg_is_read'><i class="fa fa-check"></i>เหม่ง,ลิงกัง,เค็มจังโฮ <span>อ่านแล้ว</span></div>
				</div>
			</div>

			<div class='item-chat itsme'>
				<div class='messages gal'>
					<div class='img-chat'>
						<div class='img'>
							<a href='https://www.bazarn.com/media/post_56e25920f0d71dae628b4567_1004040274.png'>
								<img src='https://www.bazarn.com/media/post_56e25920f0d71dae628b4567_1004040274.png'>
							</a>
						</div>
					</div>
					<div class='img-chat'>
						<div class='img'>
							<a href='https://im.bazarn.com/676x676/media/product_56e27075f0d71daa0e8b4567_1343950483.jpg'>
								<img src='https://im.bazarn.com/676x676/media/product_56e27075f0d71daa0e8b4567_1343950483.jpg'>
							</a>
						</div>
					</div>
					<div class='img-chat'>
						<div class='img'>
							<a href='https://im.bazarn.com/676x676/media/product_56e25920f0d71dae628b4567_715432412.jpg'>
								<img src='https://im.bazarn.com/676x676/media/product_56e25920f0d71dae628b4567_715432412.jpg'>
							</a>
						</div>
					</div>
					<div class='img-chat'>
						<div class='img'>
							<a href='https://im.bazarn.com/676x676/media/post_564953398992f718040041ad_2035307614.png'>
								<img src='https://im.bazarn.com/676x676/media/post_564953398992f718040041ad_2035307614.png'>
							</a>
						</div>
					</div>
					<div class='msg_date'>วันนี้13:36</div>
					<div class='msg_is_read'><i class="fa fa-check"></i>เหม่ง,ลิงกัง,เค็มจังโฮ <span>อ่านแล้ว</span></div>
				</div>
			</div>
			<div class='item-chat itsme'>
				<div class='messages'>
					<div class='sendlink'>
						<a href='https://www.bazarn.com' target='_blank'>link title</a>
					</div>
					<div class='msg_date'>วันนี้13:36</div>
					<div class='msg_is_read'><i class="fa fa-check"></i>เหม่ง,ลิงกัง,เค็มจังโฮ <span>อ่านแล้ว</span></div>
				</div>
			</div>

		</div>
	</div>
	<div class='chat_form'>
		<div class='chat_text_cv'>
			<div class='chat_text_input' contenteditable="true" data-placeholder='พิมพ์ข้อความ...'></div>
		</div>
	</div> 
	<div class='chat_control'>
		<button class='box_ctrl upphoto'><i class="fa fa-camera-retro"></i></button>
		<div class='dropup_emo'>
		<button class='box_ctrl emoj dropup-opener'><i class="fa fa-smile-o"></i></button>
			<div class="emo-menu emo_arr">
				<div class='inner_gray'>อารมณ์ <a href="#" class="emo-menu_close" role="button" title="Close">&times;</a></div>
			</div>
		</div>
		<div class='dropup_stk'>
			<button class='box_ctrl right stk dropup-opener'><i class="fa fa-heart"></i></button>
			<ul class="ddx-menu menu_arr">
				<li><a href="#">B</a></li>
                <li><a href="#">S</a></li>
                <li><a href="#">S</a></li>
                <li><a href="#">C</a></li>
                <li><a href="#">E</a></li>
                <li><a href="#">B</a></li>
                <li><a href="#">U</a></li>
                <li><a href="#">R</a></li>
                <li><a href="#">U</a></li>
            </ul>
		</div>
	</div>
</div>
-->

<div style="clear: both"></div></div><div class="popup-messages"></div></div>


<div class="overlay">
    <div class="bzn_dialog" style="min-height: 90px;">
	    <div class='preload'></div>
        <div class="fade">
	        
        </div>
    </div>
</div>

  <div compile="test1"></div>
  </body>
</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/angular.min.js"></script>   

<!-- <script src="/js/dropzone.js"></script> -->
 

    <script>
	    	var app = angular.module('app', []);
	    	app.directive('compile', ['$compile', function ($compile) {
			  return function(scope, element, attrs) {
			    scope.$watch(
			      function(scope) {
			        return scope.$eval(attrs.compile);
			      },
			      function(value) {
			        element.html(value);
			        $compile(element.contents())(scope);
			      }
			   )};
			  }]);
			app.controller('chat', function($scope,$http,$compile) {
			$('.include').load("http://localhost:3000/chat/master_chat.html");
			//$scope.name = '<a href="#" ng-click=close_popup()>&#10005;</a>';
			//$('.test1').html('<a href="#" ng-click=close_popup()>&#10005;</a>')
						
			$http({
			  method: 'POST',
			  data:{id:'56e25471f0d71df75d8b4567'},
			  url: '/chat/chatgroup'
			}).then(function successCallback(response) {
				$scope.list_group = response.data;
			}, function errorCallback(response) {});

						
			$http({
			  method: 'POST',
			  data:{id:'56e25471f0d71df75d8b4567'},
			  url: '/chat/chatActivities'
			}).then(function successCallback(response) {
				$scope.activities = response.data;
				
			}, function errorCallback(response) {});
			$http({
			  method: 'POST',
			  data:{id:'56e25471f0d71df75d8b4567'},
			  url: '/chat/chatlist'
			}).then(function successCallback(response) {
				console.log(response);
				$scope.list = response.data
				dataonline = [];
				$.each(response.data, function( index, value ) {
					dataonline.push(value._id);
				});
				$http({
				  method: 'POST',
				  data:dataonline,
				  url: '/chat/useronline'
				}).then(function successCallback(response) {
					console.log(response.data);

					$.each(response.data, function( index, data_online ) {
						if(data_online.status_online == 1){
							$('.online'+data_online._id).addClass('iamonline');
							$('.online_text'+data_online._id).html('ออนไลน์');
						}else if(data_online.status_online == 2){
							$('.online'+data_online._id).addClass('iamalway');
							$('.online_text'+data_online._id).html('ออนไลน์แต่กำลังทำบางอย่าง');
						}else{
							$('.online'+data_online._id).addClass('iamoffline');
							$('.online_text'+data_online._id).html('ออฟไลน์');
						}
						
						
					});

					
				})


	
	
			});
			var total_popups = 0;
			var popups = [];
			$scope.register_popup = function(id,name){
				alert(id);
				for(var iii = 0; iii < popups.length; iii++){   
	              	if(id == popups[iii]){
	                    Array.remove(popups, iii);
	                
	                    popups.unshift(id);
	                    
	                    calculate_popups();
	                    return;
	                }
	            }               
	            var element = '<div class="popup-box chat-popup" id=\"'+ id +'\">';
	            element = element + '<div class="popup-head">';
	            element = element + '<div class="popup-head-left">'+ name +'</div>';
	            element = element + '<div class="popup-head-right"><a href="#" ng-click=close_popup(\"'+id+'\")>&#10005;</a></div>';
	            element = element + '<div style="clear: both"></div></div><div class="popup-messages"></div></div>';
	           //$scope.test1 = '<a href="#" ng-click=close_popup(\"'+id+'\")>&#10005;</a>';
	           // $scope.test1 = document.getElementsByTagName("body")[0].innerHTML + element;
	           
	            //$('.test1').html(element);
	            //document.getElementsByTagName("body")[0].innerHTML = document.getElementsByTagName("body")[0].innerHTML + element;
	            var template = angular.element(element);
				temp =  $compile(template)($scope)
				$scope.body_chat = $('.list').html() + element;
				//$scope.body_chat = text;			
				
				//$('.test').html(element);
				//$scope.test1 = element;
				//console.log(element);
				//var body = document.getElementsByTagName("body")[0].innerHTML = document.getElementsByTagName("body")[0].innerHTML + element;
				//$('body').html(document.getElementsByTagName("body")[0].innerHTML + element)
				
				//document.getElementsByTagName("body")[0].innerHTML = document.getElementsByTagName("body")[0].innerHTML + element;
				//$('.body_chat').html(html);
				//document.getElementsByTagName("body")[0].innerHTML = html + temp;
				//$('.test').html(html + temp) ;
				//temp =  test;
				//$('.test').html(temp);
				//angular.element($('.test')).append(temp);
	    
	            popups.unshift(id);
	            //$scope.test = $compile(document.getElementsByTagName("body")[0].innerHTML  +   element )     
	            calculate_popups();
	           // $scope.body_chat = element;
	            				//document.getElementsByTagName("body")[0].innerHTML = temp;

	           //$('body').html(temp);
			}
			Array.remove = function(array, from, to) {
				var rest = array.slice((to || from) + 1 || array.length);
	            array.length = from < 0 ? array.length + from : from;
	            return array.push.apply(array, rest);
        	};
			
			$scope.close_popup = function(id){
				alert(id);
	            for(var iii = 0; iii < popups.length; iii++)
	            {
	                if(id == popups[iii])
	                {
		                console.log(popups[iii]);
	                    Array.remove(popups, iii);
	                    
	                    document.getElementById(id).style.display = "none";
	                    
	                    calculate_popups();
	                    
	                    return;
	                }
	            }   
	        }
			function display_popups(){
				
	            var calRight = $('.chat-sidebar-sp').width();
	            
	            var right = 340;
	            
	            var iii = 0;
	            for(iii; iii < total_popups; iii++)
	            {
		            console.log(popups[iii]);
	                if(popups[iii] != undefined)
	                {
		                console.log(popups[iii]);
		                var element = $('#56e25920f0d71dae628b4567');
	                    //var element = document.getElementById('');
	                    console.log(element)
	                    element.style.right = right + "px";
	                    right = right + 340;
	                    element.style.display = "block";
	                }
	            }
	            
	            for(var jjj = iii; jjj < popups.length; jjj++)
	            {
	                var element = document.getElementById(popups[jjj]);
	                element.style.display = "none";
	            }
	        }
			function calculate_popups(){
				
	            var width = window.innerWidth;
	            console.log(window);
	            if(width < 540){
	                total_popups = 0;
	            }
	            else{
	                width = width - 320;
	                //320 is width of a single popup box
	                total_popups = parseInt(width/340);
	            }
	            
	            display_popups();
        	}

			$scope.check_num = function(num){
				if(num > 5){
					return '...และอีก '+(num - 5)+' คน';
				}else{
					return '';
				}
			}
			
		});		 

			$('.dropup_stk').on('click', '> .dropup-opener', function(e) {
			    e.preventDefault();
			    	$menu = $(this).siblings('.ddx-menu');
				    if ($menu.hasClass('is-open')) {
				      $menu.removeClass('is-open');
				      $('.stk').html('<i class="fa fa-heart"></i>');
				    } else {
				      $menu.addClass('is-open');
				      $('.stk').html('<i class="fa fa-times"></i>');
				    }
			});
			$('.dropup_emo').on('click', '> .dropup-opener', function(e) {
			    e.preventDefault();
			    	$menu = $(this).siblings('.emo-menu');
				    if ($menu.hasClass('is-open')) {
				      $menu.removeClass('is-open');
				      $('.emoj').html('<i class="fa fa-smile-o"></i>');
				    } else {
				      $menu.addClass('is-open');
				      $('.emoj').html('<i class="fa fa-times"></i>');
				    }
			});
			$(document).on('click', '.emo-menu_close', function(e) {
				e.preventDefault();

				    if ($('.emo-menu').hasClass('is-open')) {
				      $('.emo-menu').removeClass('is-open');
				      $('.emoj').html('<i class="fa fa-smile-o"></i>');
				    } else {
				      $('.emo-menu').addClass('is-open');
				      $('.emoj').html('<i class="fa fa-times"></i>');
				    }
			});
			
			$(document).on('click','.show-friend-ingroup',function() {
				
				$('.fade').load('friend.html',function(result){
					
					$(".overlay, .bzn_dialog").css("opacity", 1);
					$(".overlay").show();
					
					var mdheight = $(".fade").height(); console.log(mdheight);
					$(".overlay, .bzn_dialog").css("opacity", 0);
					/*Remove inline styles*/
					$(".overlay, .bzn_dialog").removeAttr("style");
		
					/*Set min height to 90px after mdheight has been set*/
					$(".bzn_dialog").css("min-height", "90px");
					$(".overlay").show();
					
					$(".bzn_dialog > .preload").html("<img src='./assets/images/loading.gif' class='loader'> ");
					
					$(".bzn_dialog").css("width", "200").animate({"opacity" : 1,height : mdheight,width : "320"}, 600, function() {
					/*When animation is done show inside content*/
					
						$(".preload").empty();
					    $(".fade").show();
					});
				});	
			});
			
			$(document).on('click','.show-group-setting',function() {
				
				$('.fade').load('setting.html',function(result){
					
					$(".overlay, .bzn_dialog").css("opacity", 1);
					$(".overlay").show();
					
					var mdheight = $(".fade").height(); console.log(mdheight);
					$(".overlay, .bzn_dialog").css("opacity", 0);
					/*Remove inline styles*/
					$(".overlay, .bzn_dialog").removeAttr("style");
		
					/*Set min height to 90px after mdheight has been set*/
					$(".bzn_dialog").css("min-height", "90px");
					$(".overlay").show();
					
					$(".bzn_dialog > .preload").html("<img src='./assets/images/loading.gif' class='loader'> ");
					
					$(".bzn_dialog").css("width", "200").animate({"opacity" : 1,height : mdheight,width : "320"}, 600, function() {
					/*When animation is done show inside content*/
					
						$(".preload").empty();
					    $(".fade").show();
					});
				});	
			});
			
			$(document).on('click','.upphoto',function() {
				
				$('.fade').load('upload.html',function(result){
					
					$(".overlay, .bzn_dialog").css("opacity", 1);
					$(".overlay").show();
					
					var mdheight = $(".fade").height(); console.log(mdheight);
					$(".overlay, .bzn_dialog").css("opacity", 0);
					/*Remove inline styles*/
					$(".overlay, .bzn_dialog").removeAttr("style");
		
					/*Set min height to 90px after mdheight has been set*/
					$(".bzn_dialog").css("min-height", "90px");
					$(".overlay").show();
					
					$(".bzn_dialog > .preload").html("<img src='./assets/images/loading.gif' class='loader'> ");
					
					$(".bzn_dialog").css("width", "200").animate({"opacity" : 1,height : mdheight,width : "590"}, 600, function() {
					/*When animation is done show inside content*/
					
						$(".preload").empty();
					    $(".fade").show();
					    $("#dropzonex").dropzone({ url: "http://192.168.0.14:3000/uploads" });
					});
				});	
			});

			/*Close dialog*/
			$(document).on('click',".df_button, .dialog_close",function() {
				$(".overlay, .bzn_dialog, .fade").fadeOut("slow", function() {
					/*Remove inline styles*/
					$(".overlay, .bzn_dialog").removeAttr("style");
					$(".bzn_dialog").css("min-height", "90px");
				});
			});
			

	    /**************************/
	    $(document).ready(function(){
			$('.gal').each(function() {	
				$(this).magnificPopup({
				    delegate: 'a',
				    type: 'image',
				    gallery:{enabled:true}
				});
			});	
		    //$('.msgsc').scrollTop($('.msgsc')[0].scrollHeight);
		    
	        $(document).on('click','.dd_cog', function(){
		        $('.setting_list').slideToggle('fast');
	        });
	        $(".setting_list > li > a").click(function () {
		        //Toggle the child but don't include them in the hide selector using .not()
		        $('.dd_cog > .setting_list').not($(this).children(".setting_list").slideToggle('fast'));
		
		    });
	    
	    });
	    
	   $(document).on('keyup','.input_friend', function(){
		   var text = $('.input_friend').val();
		   if(text.length > 0){
			   $('.myfriendlist').css('display','block');
		   }else{
			   $('.myfriendlist').css('display','none');
		   }
	   });
	   $(document).on('click','.plus_friend', function(){
		   $('.find_frined').slideToggle('fast');
	   });
	   $(document).on('click','.close_find_friend', function(){
		   $('.find_frined').slideToggle('fast');
	   });
	   
	   $(document).on('click','.close_this_popup', function(){
		   $('.chat-popup').slideToggle('fast');
	   });
	   
	   
			 
	    $(document).on('click','.chat-popup header',function(e) {
			e.preventDefault();
			var chat_popup = $('.chat-popup');
			
			if (chat_popup.hasClass('hide')) {
                chat_popup.removeClass('hide');
	                $('.chatarea').slideToggle(300);
					$('.chat_form').css('display','block');
					$('.chat_control').slideToggle(300);
					$('.chat-popup-cc').slideToggle(300);
					$('.inchat-detail').slideToggle(300);
					$('.ichatwith').slideToggle(300);
					$('.name_head').css('display','none');
					$('.chat-popup').css('width','320px');
					$(this).css('cursor','s-resize');
		    } else {
		        chat_popup.addClass('hide');
		            $('.chatarea').slideToggle('fast');
					$('.chat_form').css('display','none');
					$('.chat_control').slideToggle('fast');
					$('.chat-popup-cc').slideToggle('fast');
					$('.inchat-detail').slideToggle('fast');
					$('.ichatwith').slideToggle(300);
					$('.name_head').css('display','block');
					$('.chat-popup').css('width','140px');
					$(this).css('cursor','n-resize');
		    }
	
		});
		
	    $(document).on('click','.xtabs-min',function(e) {
			e.preventDefault();
			$('.chat-sidebar-sp').slideToggle(300);
			$('.minsearch').slideToggle(300);
		});
		$(document).on('click','.minsearch',function(e) {
			e.preventDefault();
			$('.chat-sidebar-sp').slideToggle(300);
			$('.minsearch').slideToggle(300);
		});
	    
	    
	    //$('.chat-sidebar-sp').draggable({ handle: 'header' });
        //this function can remove a array element.
        Array.remove = function(array, from, to) {
            var rest = array.slice((to || from) + 1 || array.length);
            array.length = from < 0 ? array.length + from : from;
            return array.push.apply(array, rest);
        };
    
        //this variable represents the total number of popups can be displayed according to the viewport width
        var total_popups = 0;
        
        //arrays of popups ids
        var popups = [];
    
        //this is used to close a popup
        function close_popup(id)
        {
            for(var iii = 0; iii < popups.length; iii++)
            {
                if(id == popups[iii])
                {
                    Array.remove(popups, iii);
                    
                    document.getElementById(id).style.display = "none";
                    
                    calculate_popups();
                    
                    return;
                }
            }   
        }
    
        //displays the popups. Displays based on the maximum number of popups that can be displayed on the current viewport width
        function display_popups()
        {
            var calRight = $('.chat-sidebar-sp').width();
            console.log(calRight);
            var right = 340;
            
            var iii = 0;
            for(iii; iii < total_popups; iii++)
            {
	            console.log(iii);
                if(popups[iii] != undefined)
                {
                    var element = document.getElementById(popups[iii]);
                    
                    element.style.right = right + "px";
                    right = right + 340;
                    element.style.display = "block";
                }
            }
            
            for(var jjj = iii; jjj < popups.length; jjj++)
            {
                var element = document.getElementById(popups[jjj]);
                element.style.display = "none";
            }
        }
        
        //creates markup for a new popup. Adds the id to popups array.
        function register_popup(id, name)
        {
            
            for(var iii = 0; iii < popups.length; iii++)
            {   
                //already registered. Bring it to front.
                if(id == popups[iii])
                {
                    Array.remove(popups, iii);
                
                    popups.unshift(id);
                    
                    calculate_popups();
                    
                    
                    return;
                }
            }               
            
            var element = '<div class="popup-box chat-popup" id="'+ id +'">';
            element = element + '<div class="popup-head">';
            element = element + '<div class="popup-head-left">'+ name +'</div>';
            element = element + '<div class="popup-head-right"><a href="javascript:close_popup(\''+ id +'\');">&#10005;</a></div>';
            element = element + '<div style="clear: both"></div></div><div class="popup-messages"></div></div>';
            
            document.getElementsByTagName("body")[0].innerHTML = document.getElementsByTagName("body")[0].innerHTML + element;  
    
            popups.unshift(id);
                    
            calculate_popups();
            
        }
        
        //calculate the total number of popups suitable and then populate the toatal_popups variable.
        function calculate_popups()
        {
            var width = window.innerWidth;
            if(width < 540)
            {
                total_popups = 0;
            }
            else
            {
                width = width - 320;
                //320 is width of a single popup box
                total_popups = parseInt(width/340);
            }
            
            display_popups();
            
        }
        
        //recalculate when window is loaded and also when window is resized.
        window.addEventListener("resize", calculate_popups);
        window.addEventListener("load", calculate_popups);
        
    </script>
